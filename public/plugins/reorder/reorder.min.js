Revolvapp,Revolvapp.add("plugin","reorder",{defaults:{icon:'<svg height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="m3 5h10c.5522847 0 1 .44771525 1 1s-.4477153 1-1 1h-10c-.55228475 0-1-.44771525-1-1s.44771525-1 1-1zm0 4h10c.5522847 0 1 .44771525 1 1 0 .5522847-.4477153 1-1 1h-10c-.55228475 0-1-.4477153-1-1 0-.55228475.44771525-1 1-1z"/></svg>'},subscribe:{"component.set":function(){this._observe()}},init:function(){},start:function(){this.app.control.add("reorder",{icon:this.opts.reorder.icon,position:"first",except:["header","main","footer","column","table-row","table-cell"]})},stop:function(){this._stopEvents()},_observe:function(){this.$btn=this.app.control.get("reorder"),0!==this.$btn.length&&(this.$btn.addClass(this.prefix+"-handle"),this._sortable())},_sortable:function(){this._buildInstance(this.app.component.get()),this.coreParent=this.parent,this.$win=this.app.editor.getWin(),this.tolerance=this.$btn.width(),this.$clickItem=null,this.$dragItem=null,this.oldY=0,this.dragging=!1,this.$btn.on("mousedown."+this.prefix+"-reorder touchstart."+this.prefix+"-reorder",this._press.bind(this))},_press:function(t){var e=this.dom(t.target).closest(".rex-button");if(t&&t.target&&e.hasClass("rex-handle")){t.preventDefault(),this.$win.on("mouseup."+this.prefix+"-reorder touchend."+this.prefix+"-reorder",this._release.bind(this)),this.$win.on("mousemove."+this.prefix+"-reorder touchmove."+this.prefix+"-reorder",this._move.bind(this));var i=this.instance.getElement().get();this.app.component.unset(),this.dragging=!0,this.$dragItem=this._makeDragItem(i,t.target)}},_release:function(t){this._stopEvents(),this.coreParent.isEmpty()&&this.coreParent.remove(),this.app.observer.trigger=!0,this.app.observer.sync(this.$clickItem),this.oldY=0,this.dragging=!1,this._trashDragItem()},_move:function(t){if(this.$dragItem||this.dragging){t.preventDefault(),this.app.observer.trigger=!1;var e=this.app.editor.getFrameRect(),i=!1,s=0===this.oldY?0:this.oldY-t.pageY;0<s?i="up":s<0&&(i="down");var r=this.app.scroll.isTarget(),o=this._isFrameScroll(),a=this.app.$doc.scrollTop(),n=r?this.app.scroll.getTarget():this.app.$doc,h=o?this.app.editor.getDoc().scrollTop():n.scrollTop();this._moveItem(this.$dragItem,s),this.oldY=t.pageY;var p,c=!1;r?p=n.height()+n.offset().top-40:o?(p=e.bottom-40,endWin=this.app.$win.height()+a-40,endWin<p&&(p=endWin)):(c=!this.app.toolbar.isSticky(),p=this.app.$win.height()+h-40);var l=this.app.container.get("toolbar"),g=l.height(),d=o?t.pageY+e.top-h:t.pageY+e.top,m=l.offset().top+g+40;"up"===i&&0<h&&d<m&&!1===c?this._scroll(-10):"down"===i&&p<d&&this._scroll(10);var f="layer"===this.parentType&&["block"],v=!("column"===this.parentType),u=this.parent.getElements(f,["grid","column"],v),$=u.length;if("block"===this.parentType)for(var b=this.parent.getParent("layer"),_=this.parent.getElement(),I=b.getElements(["block","grid"]),x=0;x<I.length;x++){var w=I.eq(x).get();if(w!==this.$clickItem.get()&&w!==_.get()&&this._isOver(this.dom(w))){var k="up"===i?"append":"prepend",y=this.dom(w).dataget("instance"),T=y.getTarget(),Y=y.getSource();"grid"===y.type&&(T=y.$element,k="up"===i?"after":"before");var D=this.$clickItem.dataget("instance"),E=D.getSource();T[k](this.$clickItem),Y[k](E),this._buildInstance(D)}}for(var S=0;S<$;S++){var P=u.eq(S).get();P!==this.$clickItem.get()&&this._isOver(this.dom(P))&&this._swapItems(P)}}},_scroll:function(t){var e=this.app.scroll.isTarget()?this.app.scroll.getTarget():this.app.$win;this._isFrameScroll()&&(e=this.app.editor.getWin());var i=e.scrollTop();e.scrollTop(i+t)},_buildInstance:function(t){this.instance=t;var e=this.instance.getType();this.parentType="block"===e?"layer":"block",this.instance.getParent("column")&&(this.parentType="column"),this.parent="layer"===this.parentType?this.instance.getParent("layer"):this.instance.getParent(this.parentType)},_swapItems:function(t){var e=this.$dragItem.offset().top,i=this.$clickItem,s=this.dom(t),r=i.dataget("instance"),o=s.dataget("instance"),a=r.getSource(),n=o.getSource(),h=s.offset(),p=s.height()/2+h.top>e?"before":"after";s[p](i),n[p](a)},_stopEvents:function(){this.$win&&(this.$btn.off("."+this.prefix+"-reorder"),this.$win.off("."+this.prefix+"-reorder"))},_isFrameScroll:function(){return this.app.editor.getFrame().height()<this.app.editor.getBody().height()},_isOver:function(t){var e=this.$dragItem.offset().top,i=t.offset(),s=t.height();return e>i.top&&e<i.top+s},_moveItem:function(t,e){var i=t.offset().top;i-=e,t.css("top",i+"px")},_makeDragItem:function(t){this._trashDragItem();var e=this.dom(t),i=e.offset();this.$clickItem=e,this.$clickItem.addClass(this.prefix+"-drag-active");var s=e.clone();s.removeClass(this.prefix+"-drag-active "+this.prefix+"-element-active");var r=this.dom("<div>").addClass(this.prefix+"-dragging");return r.append(s),r.css({opacity:.95,position:"absolute","z-index":999,left:i.left+"px",top:i.top+"px",width:e.width()+"px"}),this.app.editor.getBody().append(r),r},_trashDragItem:function(){this.$dragItem&&this.$clickItem&&(this.$clickItem.removeClass(this.prefix+"-drag-active"),this.$clickItem=null,this.$dragItem.remove(),this.$dragItem=null)}});